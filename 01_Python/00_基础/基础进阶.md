## 日志

> - https://www.cnblogs.com/SnowPhoenix/p/15201097.html

### basicConfig

这个函数对logging模块的日志记录器进行基本配置，无论我们直接通过`logging.info(msg)`进行日志记录，还是我们先通过`logging.getLogger(name)`获取一个logger再进行日志记录，通过`basicConfig`函数加入的配置都会生效。

值得注意的是，因为有些操作会导致`basicConfig`函数被自动调用，所以我们尽量在程序开始时尽早进行调用。

我们需要关注的是`basicConfig`的`handlers`参数。

### handler

如果说logger是面向上层开发者的接口，那么handler就是面向底层的执行者。开发者通过调用logger的方法来输出日志，而logger通过handler将日志进行实际的记录。

一个logger可以有若干handler，logger和handler都可以有一个日志等级。当记录等级高于logger的日志时，logger会通知每一个handler对该日志进行记录，而每一个handler记录会通过该条日志的等级和handler的等级进行比较，当日志等级高于handler等级的时候，才会进行记录。

handler主要位于[logging.handler](https://docs.python.org/zh-cn/3/library/logging.handlers.html?highlight=filehandler#logging.FileHandler)包下，我们这次需要使用`StreamHandler`以及其子类`FileHandler`。

### 实现

通过前面的分析，思路已经很清晰了：

1. 创建两个handler，其中一个向控制台进行输出，一个向文件进行输出；
2. 为这两个handler配置不同的日志等级和日志格式；
3. 通过`basicConfig`函数来将这两个handler添加到全局日志的默认配置；

以下为实现：

```Python
#!/usr/bin/python 3.10
# -*- coding: utf-8 -*- 
#
# @Time    : 2023-05-20 18:55
# @Author  : 发发
# @QQ      : 1315337973
# @GitHub  : https://github.com/lovely-fafa
# @File    : log.py
# @Software: PyCharm

import logging
import sys

import colorlog


def config_logging(file_name: str, console_level: int = logging.DEBUG, file_level: int = logging.DEBUG):
    logging.getLogger("requests").setLevel(logging.WARNING)
    logging.getLogger("urllib3").setLevel(logging.WARNING)

    file_handler = logging.FileHandler(file_name, mode='w', encoding="utf8")
    file_handler.setFormatter(colorlog.ColoredFormatter(
        '[%(asctime)s %(levelname)s] %(message)s',
        datefmt="%Y/%m/%d %H:%M:%S",
        log_colors={
            'DEBUG': 'cyan',
            'INFO': 'green',
            'WARNING': 'yellow',
            'ERROR': 'red',
            'CRITICAL': 'bold_red',
        }
    ))
    file_handler.setLevel(file_level)

    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(colorlog.ColoredFormatter(
        '[%(asctime)s %(levelname)s] %(message)s',
        datefmt="%Y/%m/%d %H:%M:%S",
        log_colors={
            'DEBUG': 'cyan',
            'INFO': 'green',
            'WARNING': 'yellow',
            'ERROR': 'red',
            'CRITICAL': 'bold_red',
        }
    ))
    console_handler.setLevel(console_level)

    logging.basicConfig(
        level=min(console_level, file_level),
        handlers=[file_handler, console_handler],
    )


if __name__ == '__main__':
    config_logging("test.log")
    logging.debug("debug")
    logging.info("info")
    logging.warning("warning")
    logging.critical("critical")

    logger = logging.getLogger(__name__)
    logger.debug("debug")
    logger.info("info")
    logger.warning("warning")
    logger.critical("critical")
```

关键是`config_logging`函数，这个函数进行了基本的配置，我们只需要在程序的入口处先调用这个函数就能完成全局的日志配置。

需要注意的是在调用`logging.basicConfig`时，我们需要设置`level=min(console_level, file_level)`，这是因为这个参数设置的是logger的等级，如果一条日志已经被logger过滤掉了，那么handler的等级设置的再低也不会进行记录。直接`level=logging.DEBUG`、`level=0`应该也可以，但是我认为比所有handler的等级都低的日志是不会进行输出的，与其让这条日志到了handler这一步才被过滤，不如直接就在logger这一步就将其过滤掉。

关于Formatter相关的操作，请看[下一篇博客](https://www.cnblogs.com/SnowPhoenix/p/15201251.html)。